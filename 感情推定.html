// 依存なし。環境変数 GOOGLE_TRANSLATE_API_KEY を Workers に設定しておく。
// curl 例: https://translation.googleapis.com/language/translate/v2?key=...&q=TEXT&source=ja&target=en
export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    if (url.pathname !== '/translate') return new Response('Not found', { status: 404 });
    if (request.method !== 'POST') return new Response('Method Not Allowed', { status: 405 });

    try {
      const { text, source = 'ja', target = 'en' } = await request.json();

      if (!text || typeof text !== 'string') {
        return new Response(JSON.stringify({ error: 'text required' }), { status: 400 });
      }

      const params = new URLSearchParams({
        q: text,
        source,
        target,
        format: 'text',
        key: env.GOOGLE_TRANSLATE_API_KEY
      });

      const r = await fetch('https://translation.googleapis.com/language/translate/v2?' + params.toString(), {
        method: 'POST'
      });
      if (!r.ok) {
        const body = await r.text();
        return new Response(JSON.stringify({ error: 'gtranslate failed', body }), { status: 502 });
      }
      const j = await r.json();
      const translated = j?.data?.translations?.[0]?.translatedText ?? '';

      return new Response(JSON.stringify({ text: translated }), {
        headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' }
      });
    } catch (e) {
      return new Response(JSON.stringify({ error: String(e) }), { status: 500 });
    }
  }
};
