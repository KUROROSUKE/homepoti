<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>USEで日本語ポジ/ネガ推定（完全クライアント）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- 404回避のダミーfavicon -->
  <link rel="icon" href="data:,">
  <style>
    body{font-family:system-ui,sans-serif;margin:20px}
    textarea{width:100%;height:140px;font-size:16px}
    .panel{border:1px solid #ddd;border-radius:8px;padding:12px;margin-top:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap}
    .badge{display:inline-block;padding:2px 8px;border-radius:12px;background:#eee}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>USEで日本語ポジ/ネガ推定（ゼロショット・類似度）</h1>

  <label for="text">テキスト</label>
  <textarea id="text" placeholder="例）今日は最高の気分だ。でも少し不安もある。"></textarea>
  <div class="muted">
    ※ Universal Sentence Encoder で埋め込み → ポジ/ネガ代表文とコサイン類似度を比較。<br>
    ※ しきい値は調整可。完全クライアント・鍵不要。
  </div>

  <div class="panel">
    <div>判定: <span id="label" class="badge">-</span></div>
    <div>score(+-): <span id="score" class="mono">-</span></div>
    <hr>
    <div>詳細:</div>
    <pre id="detail" class="mono">-</pre>
  </div>

  <!-- 必須: tfjs を先に読み込む -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  <!-- 次に USE 本体（tf の上に乗る） -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>

  <script>
    // ---------------------------------------------
    // 設定
    // ---------------------------------------------
    const POS_PROTOS = [
      '嬉しい','楽しい','最高だ','大好き','幸せ','素晴らしい','満足している','ありがたい',
      'ワクワクする','快適だ','最高の気分だ','心が躍る','応援したい','素敵だ'
    ];
    const NEG_PROTOS = [
      '最悪だ','嫌い','悲しい','腹が立つ','イライラする','不安だ','つらい','しんどい',
      '不快だ','後悔している','絶望だ','怖い','やめたい','むかつく'
    ];
    const NEUTRAL_MARGIN = 0.05;

    // ---------------------------------------------
    // 数学ユーティリティ
    // ---------------------------------------------
    function dot(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }
    function norm(a){ return Math.sqrt(dot(a,a)); }
    function cosine(a,b){ return dot(a,b) / (norm(a)*norm(b) + 1e-12); }

    // ---------------------------------------------
    // モデルとプロトタイプ埋め込みの準備
    // ---------------------------------------------
    let useModel=null, posEmbeds=null, negEmbeds=null;

    async function setup(){
      // tf の初期化を待つ
      await tf.ready();
      // USE 読み込み（グローバル use）
      useModel = await use.load();
      // 代表文の埋め込みを先に計算してキャッシュ
      const texts = POS_PROTOS.concat(NEG_PROTOS);
      const em = await useModel.embed(texts);
      const arr = await em.array();
      posEmbeds = arr.slice(0, POS_PROTOS.length);
      negEmbeds = arr.slice(POS_PROTOS.length);
      em.dispose();
    }

    // ---------------------------------------------
    // 推定
    // ---------------------------------------------
    async function predict(text){
      const em = await useModel.embed([text]);
      const [vec] = await em.array();
      em.dispose();

      let pos = 0, neg = 0;
      for (const v of posEmbeds) pos += cosine(vec, v);
      for (const v of negEmbeds) neg += cosine(vec, v);
      pos /= posEmbeds.length;
      neg /= negEmbeds.length;

      const score = Math.max(-1, Math.min(1, (pos - neg)));
      let label = 'NEUTRAL';
      if (score > NEUTRAL_MARGIN) label = 'POSITIVE';
      else if (score < -NEUTRAL_MARGIN) label = 'NEGATIVE';

      return { label, score: Number(score.toFixed(3)), posSim: Number(pos.toFixed(3)), negSim: Number(neg.toFixed(3)) };
    }

    // ---------------------------------------------
    // UI
    // ---------------------------------------------
    const $ = id => document.getElementById(id);
    const t = $('text'), labelEl = $('label'), scoreEl = $('score'), detailEl = $('detail');

    let ready=false;
    (async () => {
      try{
        labelEl.textContent = '読み込み中…';
        await setup();
        ready=true;
        labelEl.textContent='-';
        t.value = '今日は最高の気分だ。でも少し不安もある。';
        run();
      }catch(e){
        labelEl.textContent='ERROR';
        scoreEl.textContent='?';
        detailEl.textContent=String(e);
      }
    })();

    let timer=null;
    t.addEventListener('input', ()=>{ clearTimeout(timer); timer=setTimeout(run,300); });

    async function run(){
      if (!ready) return;
      const text = t.value.trim();
      if (!text){ labelEl.textContent='-'; scoreEl.textContent='-'; detailEl.textContent='-'; return; }
      const r = await predict(text);
      labelEl.textContent = r.label;
      scoreEl.textContent = String(r.score);
      detailEl.textContent = `posSim=${r.posSim}, negSim=${r.negSim}`;
    }
  </script>
</body>
</html>
