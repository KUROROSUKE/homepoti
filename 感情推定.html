<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>日本語 感情分析（単一HTML・フォルダ不要）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<h1>日本語 感情分析（単一HTML）</h1>

<!-- 入力 -->
<textarea id="txt" rows="6" cols="60">今日は最高。だけど明日は不安。</textarea><br />
<button id="run">推論</button>
<pre id="out"></pre>

<!-- 1) ライブラリはCDNから（小さめ）。モデルは外部通信しない -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.0/dist/ort.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/otodn/sentiment_ja_js@master/dist/sentimentja_onnx.js"></script>

<script>
/* 2) モデルファイルをHTML内に埋め込む（Base64）。必要に応じて項目を追加。
   - 左がモデル側の相対パス（元は ./model/ にあった想定）
   - 右が Base64 文字列（application/octet-stream or utf-8）
   例: base64は  `base64 -w0 ファイル` で作成
*/
const FILES = {
  "tokenizer.json": "PASTE_BASE64_HERE",          // 例
  "vocab.txt":      "PASTE_BASE64_HERE",          // 例
  "config.json":    "PASTE_BASE64_HERE",          // 例
  "model.onnx":     "PASTE_BASE64_HERE"           // 例（大きい）
};

/* 3) fetch をフック。Analyzer.init("./model/") が行う取得を横取りし、埋め込みBlobを返す */
const ORIG_FETCH = window.fetch.bind(window);
window.fetch = async function(url, opts) {
  try {
    const u = typeof url === 'string' ? url : url.url;
    // sentiment_ja_js は "./model/<name>" を相対取得する想定
    const m = u.match(/\/model\/(.+)$/) || u.match(/\.\/model\/(.+)$/) || u.match(/^model\/(.+)$/);
    if (m) {
      const name = m[1];
      if (!(name in FILES)) {
        return new Response("not found in embedded FILES: " + name, { status: 404 });
      }
      const b64 = FILES[name];
      const bin = atob(b64);
      const buf = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
      // 簡易MIME判定
      const type =
        name.endsWith(".json") ? "application/json" :
        name.endsWith(".txt")  ? "text/plain; charset=utf-8" :
        "application/octet-stream";
      return new Response(new Blob([buf], { type }), { status: 200 });
    }
  } catch(e) {
    console.warn("fetch hook error, falling back:", e);
  }
  return ORIG_FETCH(url, opts);
};

/* 4) 実行部（import不要） */
let analyzer;
async function init() {
  if (!window.SentimentJa) throw new Error("sentimentja_onnx.js 未読込");
  // ./model/ を指定しても、上の fetch フックが埋め込みBlobを返すためフォルダ不要
  analyzer = await window.SentimentJa.Analyzer.init("./model/");
}

document.getElementById("run").onclick = async () => {
  const out = document.getElementById("out");
  try {
    if (!analyzer) {
      out.textContent = "初期化中...";
      await init();
    }
    const inputs = document.getElementById("txt").value
      .split(/\n+/).map(s => s.trim()).filter(Boolean);
    const result = await analyzer.analyze(inputs);
    out.textContent = JSON.stringify(result, null, 2); // {joy, anger, ...}
  } catch (e) {
    out.textContent = "推論エラー: " + e.message;
    console.error(e);
  }
};
</script>
</body>
</html>
